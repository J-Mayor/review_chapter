%% aaskaiid.sty
%% Copyright 2024 SKAO
%
% This work may be distributed and/or modified under the
% conditions of the LaTeX Project Public License, either version 1.3
% of this license or (at your option) any later version.
% The latest version of this license is in
%   http://www.latex-project.org/lppl.txt
% and version 1.3 or later is part of all distributions of LaTeX
% version 2005/12/01 or later.
%
% This work has the LPPL maintenance status `author-maintained'.
%
% The Current Maintainer of this work is
% SKAO Science Team <science@skao.int>
%

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{aaskaiid} [2024/09/22 v0.1 Advancing Astrophysics with the
SKA - II]

\RequirePackage[T1]{fontenc}
\RequirePackage[utf8]{inputenc}


\ProcessOptions\relax

\RequirePackage{newtxtext}
\RequirePackage{amsthm} 
\RequirePackage{newtxmath}
\RequirePackage{parskip}
\RequirePackage[round]{natbib}

\def\mathsterling{\mbox{\textsterling}}
\def\pounds{\mbox{\textsterling}} 
\DeclareMathAlphabet{\mathfrak}{U}{euf}{m}{n}
\SetMathAlphabet{\mathfrak}{bold}{U}{euf}{b}{n}
\RequirePackage[zerostyle=e]{newtxtt}
\RequirePackage{amsmath}
\RequirePackage{graphicx}
\RequirePackage[font=small,labelfont=bf]{caption}
\RequirePackage{xcolor}
\definecolor{skaoblue}{cmyk}{.87 .97 0. 0.}
\RequirePackage[colorlinks=true
,urlcolor=skaoblue
,anchorcolor=skaoblue
,citecolor=skaoblue
,filecolor=skaoblue
,linkcolor=skaoblue
,menucolor=skaoblue
,linktocpage=true
,pdfa=true
]{hyperref}

\newif\ifdotoc\dotocfalse
\newif\ifemailadd\emailaddfalse
\newif\iftoccontinuous\toccontinuousfalse
\newif\ifshorttitle\shorttitlefalse

\newif\ifshortname\shortnamefalse

\RequirePackage{expl3}
\RequirePackage{xparse}

\ExplSyntaxOn

%% a sequence of "superscripts"
%% (in the same order as the authors)
\seq_new:N \l_super_s

%% a sequence of "authors"
%% (in the same order as the superscripts)
\seq_new:N \l_authors_s


%% a boolean to indicate authors should be manually separated by the
%% operator or automatically by "," and "and"
\bool_new:N\l_manually_separate_authors_bool\bool_set_false:N\l_manually_separate_authors_bool
\newcommand{\manuallySeparateAuthors}{\bool_set_true:N\l_manually_separate_authors_bool}


\newcommand{\speakerFlag}{\ast}


%% accumulate authors
\RenewDocumentCommand\author{som}{%
  \seq_put_right:Nn \l_authors_s {#3}
      % save the superscripts with the same order as the authors
      \seq_put_right:Nn \l_super_s {#2}    
  }


\tl_new:N\l_author_tl
\tl_new:N\l_superscript_tl
\int_new:N\l_num_authors_int
\str_new:N\l_au_separator_pre_str
\str_new:N\l_au_separator_post_str

%% output
\newcommand{\printAuthors}{%

  \int_zero_new:N\l_count_authors_int
  \str_set:Nn\l_au_separator_pre_str{,}
  \str_set:Nn\l_au_separator_post_str{~}

  % the number of authors
  \int_set:Nn\l_num_authors_int{\seq_count:N\l_authors_s}

  \int_compare:nNnTF             % If
      {\l_num_authors_int}       % the length of the authors
      =                          % is equal
      {1}                        % to 1
      {                          % then output the author:
        % get the author name and superscripts
        \seq_pop_left:NN\l_authors_s\l_author_tl
        \seq_pop_left:NN\l_super_s\l_superscript_tl

        \tl_use:N\l_author_tl$^{\tl_use:N\l_superscript_tl}$



      }
      {                          % otherwise output all
        % if the operator included the separations (",", "and")
        % simpy output the names
        \bool_if:NTF\l_manually_separate_authors_bool
        {
          \bool_do_until:nn
               {\seq_if_empty_p:N\l_authors_s}
               {
                 % get the author name and superscripts
                 \seq_pop_left:NN\l_authors_s\l_author_tl
                 \seq_pop_left:NN\l_super_s\l_superscript_tl
                 \tl_use:N\l_author_tl
                 $^{\tl_use:N\l_superscript_tl}$
               }
        }

        % otherwise separate automatically
        {
          \bool_do_until:nn
               {\seq_if_empty_p:N\l_authors_s}
               {
                 % get the author name and superscripts
                 \seq_pop_left:NN\l_authors_s\l_author_tl
                 \seq_pop_left:NN\l_super_s\l_superscript_tl

                 % step the counter
                 \int_incr:N\l_count_authors_int

                 % if we are looking at the next-to-last author,
                 % then change the separator
                 \int_compare:nNnT
                     {\l_count_authors_int}
                     =
                     {\int_eval:n{\l_num_authors_int - 1}}
                     {
                       \str_set:Nn\l_au_separator_pre_str{}
                       \str_set:Nn\l_au_separator_post_str{~and~}
                    
                     }
                 % if we are looking at the last author,
                 % do not add anything at the end
                 \int_compare:nNnT
                     {\l_count_authors_int}
                     =
                     {\l_num_authors_int}
                     {
                       \str_set:Nn\l_au_separator_pre_str{}
                       \str_set:Nn\l_au_separator_post_str{}
                     }
                 \tl_use:N\l_author_tl
                 \str_use:N\l_au_separator_pre_str
                 $^{\tl_use:N\l_superscript_tl}$
                 \str_use:N\l_au_separator_post_str
               }
        }
      }



    
}





\ExplSyntaxOff


\renewcommand{\baselinestretch}{1.1}\normalsize
\setlength\lineskip{1\p@}
%\setlength\parindent{1.2\parindent}
\setlength\normallineskip{1\p@}
%\setlength\parskip{0\p@ \@plus \p@}

% Settings for how much of the page can be used for floats
\setcounter{topnumber}{4}
\renewcommand\topfraction{.9} 
\setcounter{bottomnumber}{2}
\renewcommand\bottomfraction{.5}
\setcounter{totalnumber}{6}
\renewcommand\textfraction{.1}
\renewcommand\floatpagefraction{.9}
\setcounter{dbltopnumber}{3}
\renewcommand\dbltopfraction{.9}
\renewcommand\dblfloatpagefraction{.9}

% Length definitions
\setlength{\floatsep}{12pt plus 2pt minus 4pt}
\setlength{\textfloatsep}{20pt plus 3pt minus 8pt}
\setlength{\intextsep}{12pt plus 2pt minus 4pt}
\textwidth  .72\paperwidth	
\setlength\@tempdima{.76\paperheight}	
\divide\@tempdima\baselineskip		
\@tempcnta=\@tempdima			
\setlength\textheight{\@tempcnta\baselineskip}
\addtolength\textheight{\topskip}
\voffset -1in
\topmargin   .06\paperheight	
\headheight  .02\paperheight	
\headsep     .03\paperheight	
\footskip    .04\paperheight	
\marginparsep 9\p@		
\marginparpush 6\p@		
\hoffset -1in				
\oddsidemargin .14\paperwidth	
\evensidemargin .14\paperwidth	
\marginparwidth .11\paperwidth	


% Header and footer
\def\ps@aaskaii{%
  \def\@oddfoot{%
    \ifnum\value{page}=1
    % copyright and link on front page footer
	\thecopyright@box\hfill%
    \small\skaourl%
	%\tiny\booktitle@box%
	\else%
    % page numbers on all other pages footers
    \reset@font\hfil\thepage\hfil%
    \fi}%
  \def\@oddhead{%
    \ifnum\value{page}=1
   \hspace{0.cm}\booktitle@box%
    % logo on first page header
    \hfill
   {\logo}%
    \else%
    % running headers on all other pages
    \smash{\vbox{\hsize=\textwidth\noindent
	    \ifshorttitle{\it\@shorttitle}\else{\small\it\@title}\fi\hfill
	    \it\@shortname\vskip.17em }}%
    \fi}%
  \let\@mkboth\@gobbletwo  %%%%
  \let\sectionmark\@gobble
  \let\subsectionmark\@gobble
}


% Define all our variables as empty
\def\@subheader{\@empty}
\def\@abstract{\@empty}
\def\@xtum{\@empty}
\def\@accepted{\@empty}
\def\@received{\@empty}
\def\@revised{\@empty}
\def\@published{\@empty}
\def\doi@url{\@empty}
\def\doi@anchor{\@empty}
\def\@shorttitle{\@empty}
\def\@shortname{\@empty}


\def\logo{\raisebox{-12mm}{\hbox{\noindent\includegraphics{SKAO Pictorial mark-01.png}}}}

% Populate variables
\newcommand{\subheader}[1]{\gdef\@subheader{#1}}
\renewcommand{\abstract}[1]{\gdef\@abstract{#1}}
\newcommand{\ShortTitle}[1]{\gdef\@shorttitle{#1}\shorttitletrue}
\newcommand{\ShortName}[1]{\gdef\@shortname{#1}\shortnametrue}

\newcommand\skaourl{\url{https://skao.int/}}



% Copyright
\gdef\thecopyright@box{\parbox[b]{.5\textwidth}{\small $\copyright$ The Authors}}
% Book title
\gdef\booktitle@box{\parbox[b]{.85\textwidth}{ \textcolor{skaoblue}{\small\it Chapter in \normalfont\bf Advancing Astrophysics with the SKA -- II}}}
%: Preparing for Science with the SKAO}}}


% Affiliations
\newtoks\affil@toks\newif\ifaffil\affilfalse
\newcommand{\affiliation}[2][]{%
\affiltrue
  \if!#1!%
    \affil@toks=\expandafter{\the\affil@toks{\item[]#2}}%
  \else
    \affil@toks=\expandafter{\the\affil@toks{\item[$^{#1}$]#2}}%
  \fi
}

% E-mails
\newtoks\email@toks\newcounter{email@counter}%
\setcounter{email@counter}{0}%
\newcommand{\emailAdd}[1]{%
\emailaddtrue%
\ifnum\theemail@counter>0\email@toks=\expandafter{\the\email@toks, \@email{#1}}%
\else\email@toks=\expandafter{\the\email@toks\@email{#1}}%
\fi\stepcounter{email@counter}}
\newcommand{\@email}[1]{\href{mailto:#1}{#1}}

\renewcommand{\@dotsep}{10000}

% Hooks after various pieces of the title page
% (these hooks also define the spacing between the pieces)
\newlength{\affiliationsSep}\setlength{\affiliationsSep}{-6pt}
\newcommand{\hookBeforeTitle}{\vskip2em   plus .4fill  minus 1em}
\newcommand{\hookAfterTitle}{\vskip1em plus .1fill  minus 1em}
\newcommand{\hookAfterAuthor}{\relax}
\newcommand{\hookAfterAffiliation}{\relax}
\newcommand{\hookAfterEmail}{\vskip16pt plus0.2fill minus10pt\filbreak}
\newcommand{\hookAfterAbstract}{\vskip1.5em plus .05fill minus 1em}

\renewcommand\maketitle{\pagestyle{aaskaii}%
  \begingroup%
  \begin{flushleft}%				
    \null
    %
    \hookBeforeTitle
    %
    \noindent\hspace{-0.cm}{\LARGE          % TITLE
      \bfseries\boldmath
      \@title\par}%
    %
    \hookAfterTitle
    %  
           {%
             \raggedright%
             \renewcommand\baselinestretch{1.2}%
             \large%
             \printAuthors%
             \par
           }
    %
    \hookAfterAuthor
    % Affiliations
    \ifaffil\begin{list}{}{%
      \setlength{\leftmargin}{0.2cm}%
      \setlength{\labelsep}{0pt}%
      \setlength{\labelwidth}{1em}%
      \setlength{\itemsep}{\affiliationsSep}%
      \setlength{\topsep}{-0.5\parskip}}
    \itshape\small%
    \the\affil@toks
    \end{list}\fi
    %
    \hookAfterAffiliation
    %
    \ifemailadd %% if emailadd is true
    \noindent\hspace{0.cm}\begin{minipage}[l]{.9\textwidth}
      \begin{flushleft}
        {E-mail:} {\ttfamily\small\the\email@toks}
      \end{flushleft}
    \end{minipage}\fi
    %
    \hookAfterEmail
    %
    % abstract 
    \if!\@abstract!\else%
    \noindent\hspace{0.4cm}
    \parbox{.9\textwidth}{\large\ignorespaces\@abstract\normalsize}%
    \fi%
    %
    \hookAfterAbstract
    \vfill
  \end{flushleft}%
  %
  \newpage				% END OF PAGE
  \endgroup
  \flushbottom


}
%%%%%%%%%%%%%%%%%%%%%%%%%% ACTUAL TITLEPAGE %%%%%%%%%%%%%%%%%%%%%%%%%%%


\setcounter{secnumdepth}{3}

\newcommand\secstyle{\bfseries\raggedright}

\renewcommand\section{\@startsection{section}{1}{\z@}%
                                   {3.5ex \@plus 1.3ex \@minus .7ex}%
                                   {2.3ex \@plus.4ex \@minus .4ex}%
                                   {\normalfont\large\secstyle}}
\renewcommand\subsection{\@startsection{subsection}{2}{\z@}%
                                   {2.3ex\@plus 1ex \@minus .5ex}%
                                   {1.2ex \@plus .3ex \@minus .3ex}%
                                   {\normalfont\normalsize\secstyle}}
\renewcommand\subsubsection{\@startsection{subsubsection}{3}{\z@}%
                                   {2.3ex\@plus 1ex \@minus .5ex}%
                                   {1ex \@plus .2ex \@minus .2ex}%
                                   {\normalfont\it\normalsize\raggedright}}
\renewcommand\paragraph{\@startsection{paragraph}{4}{\z@}%
                                   {1.75ex \@plus1ex \@minus.2ex}%
                                   {-1em}%
                                   {\normalfont\normalsize\bfseries}}
\renewcommand\subparagraph{\@startsection{subparagraph}{5}{\parindent}%
                                   {1.75ex \@plus1ex \@minus .2ex}%
                                   {-1em}%
                                   {\normalfont\normalsize\bfseries}}

